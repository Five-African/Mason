/**
 * Mason
 * https://github.com/Five-African/Mason
 * 
 * Copyright 2016 Five-African
 * Released under the Apache License 2.0
 */
!function(n){function r(n){this.vars=Object.create(n?n.vars:null),this.parent=n}r.prototype={extend:function(){return new r(this)},lookup:function(n){for(var r=this;r;){if(Object.prototype.hasOwnProperty.call(r.vars,n))return r;r=r.parent}},get:function(n){if(n in this.vars)return this.vars[n];throw new Error("Undefined variable "+n)},set:function(n,r){var t=this.lookup(n);if(/[a-z]/.test(n))return(t||this).vars[n]=r;throw new Error("Cannot assign constant "+n)},def:function(n,r){return this.vars[n]=r}},n.Mason=n.Mason||{},n.Mason.Environment=r}(window),function(n){function r(n,u){switch(n.type){case"num":case"str":case"bool":return n.value;case"var":return u.get(n.value);case"assign":if("var"!=n.left.type)throw new Error("Cannot assign to "+JSON.stringify(n.left));return u.set(n.left.value,r(n.right,u));case"binary":return t(n.operator,r(n.left,u),r(n.right,u));case"func":return e(u,n);case"if":var o=r(n.cond,u);return o!==!1?r(n.then,u):n["else"]?r(n["else"],u):!1;case"prog":var a=!1;return n.prog.forEach(function(n){a=r(n,u)}),a;case"call":var i=r(n.func,u);return i.apply(null,n.args.map(function(n){return r(n,u)}));default:throw new Error("I don't know how to evaluate "+n.type)}}function t(n,r,t){function e(n){if("number"!=typeof n)throw new Error("Expected number but got "+n);return n}function u(n){if(0==e(n))throw new Error("Divide by zero");return n}switch(n){case"+":return e(r)+e(t);case"-":return e(r)-e(t);case"*":return e(r)*e(t);case"/":return e(r)/u(t);case"%":return e(r)%u(t);case"&&":return r!==!1&&t;case"||":return r!==!1?r:t;case"<":return e(r)<e(t);case">":return e(r)>e(t);case"<=":return e(r)<=e(t);case">=":return e(r)>=e(t);case"==":return r===t;case"!=":return r!==t}throw new Error("Can't apply operator "+n)}function e(n,t){function e(){for(var e=t.vars,u=n.extend(),o=0;o<e.length;++o)u.def(e[o],o<arguments.length?arguments[o]:!1);return r(t.body,u)}return e}n.Mason=n.Mason||{},n.Mason.Evaluate=r}(window),function(n){var r=n.Mason=n.Mason||{};r.Execute=function(n,t){t=t||new r.Environment;var e=r.AST(n);return r.Evaluate(e,t)}}(window),function(n){function r(n){function r(){var r=n.charAt(o++);return"\n"==r?(a++,i=0):i++,r}function t(){return n.charAt(o)}function e(){return""==t()}function u(n){throw new Error(n+" ("+a+":"+i+")")}var o=0,a=1,i=0;return{next:r,peek:t,eof:e,croak:u}}function t(n){function r(n){return k.indexOf(" "+n+" ")>=0}function t(n){return/[0-9]/i.test(n)}function e(n){return/[a-z_\$]/i.test(n)}function u(n){return e(n)||"_$0123456789".indexOf(n)>=0}function o(n){return"+-*/%=&|<>!".indexOf(n)>=0}function a(n){return",(){}[]".indexOf(n)>=0}function i(n){return"\n".indexOf(n)>=0}function c(n){return" 	".indexOf(n)>=0}function f(r){for(var t="";!n.eof()&&r(n.peek());)t+=n.next();return t}function s(){var n=!1,r=f(function(r){return"."==r?n?!1:(n=!0,!0):t(r)});return{type:"num",value:parseFloat(r)}}function p(){var n=f(u);return{type:r(n)?"kw":"var",value:n}}function v(r){var t=!1,e="";for(n.next();!n.eof();){var u=n.next();if(t)e+=u,t=!1;else if("\\"==u)t=!0;else{if(u==r)break;e+=u}}return e}function l(){return{type:"str",value:v('"')}}function h(){f(function(n){return c(n)||i(n)})}function y(){f(function(n){return"\n"!=n}),n.next()}function E(){if(f(c),n.eof())return null;var r=n.peek();return"#"==r?(y(),E()):'"'==r?l():t(r)?s():e(r)?p():a(r)?{type:"punc",value:n.next()}:o(r)?{type:"op",value:f(o)}:i(r)?(h(),{type:"separator"}):void n.croak("Can't handle character: "+r)}function w(){return d||(d=E())}function g(){var n=d;return d=null,n||E()}function x(){return null==w()}var d=null,k=" IF ELSE THEN FUNC TRUE FALSE DO END ";return{next:g,peek:w,eof:x,croak:n.croak}}function e(n){function r(r){var t=n.peek();return t&&"punc"==t.type&&(!r||t.value==r)&&t}function t(r){var t=n.peek();return t&&"kw"==t.type&&(!r||t.value==r)&&t}function e(r){var t=n.peek();return t&&"op"==t.type&&(!r||t.value==r)&&t}function o(){var r=n.peek();return r&&"separator"==r.type}function a(t){r(t)?n.next():n.croak('Expecting punctuation: "'+t+'"')}function i(r){t(r)?n.next():n.croak('Expecting keyword: "'+r+'"')}function c(){o()?n.next():n.croak("Expecting line break")}function f(){n.croak("Unexpected token: "+JSON.stringify(n.peek()))}function s(r,t){var u=e();if(u){var o=M[u.value];if(o>t)return n.next(),s({type:"="==u.value?"assign":"binary",operator:u.value,left:r,right:s(d(),o)},t)}return r}function p(r,e){for(var u=[],i=!0;!(n.eof()||t("DO")||o()||(i?i=!1:a(","),t("DO")||o()));)u.push(r());return!e&&t("DO")&&u.push(O()),u}function v(r,e,u,f){var s=[],p=!0;for(i(r),o()&&c();!n.eof()&&!t(e)&&(p?p=!1:"\n"==u?c():a(u),!t(e));)s.push(f());return o()&&c(),i(e),s}function l(r,e){for(var u=[],o=!0;!(n.eof()||t("ELSE")||t("END")||(o?o=!1:"\n"==r?c():a(r),t("ELSE")||t("END")));)u.push(e());return u}function h(n){return{type:"call",func:n,args:p(D)}}function y(){var r=n.next();return"var"!=r.type&&n.croak("Expecting variable name"),r.value}function E(){i("IF");var r=D();i("THEN"),o()&&c();var e=b(),u={type:"if",cond:r,then:e};return t("ELSE")&&(n.next(),o()&&c(),u["else"]=b()),i("END"),u}function w(){return{type:"func",vars:p(y,!0),body:O()}}function g(){return{type:"bool",value:"TRUE"==n.next().value}}function x(r){return r=r(),"var"!=r.type||e()||o()||t()&&!t("DO")||n.eof()?r:h(r)}function d(){return x(function(){if(r("(")){n.next();var e=D();return a(")"),e}if(t("DO"))return O();if(t("IF"))return E();if(t("TRUE")||t("FALSE"))return g();if(t("FUNC"))return n.next(),w();var u=n.next();return"var"==u.type||"num"==u.type||"str"==u.type?u:void f()})}function k(){for(var r=[];!n.eof();)r.push(D()),n.eof()||c();return{type:"prog",prog:r}}function O(){var n=v("DO","END","\n",D);return 0==n.length?u:1==n.length?n[0]:{type:"prog",prog:n}}function b(){var n=l("\n",D);return 0==n.length?u:1==n.length?n[0]:{type:"prog",prog:n}}function D(){return x(function(){return s(d(),0)})}var M={"=":1,"||":2,"&&":3,"<":7,">":7,"<=":7,">=":7,"==":7,"!=":7,"+":10,"-":10,"*":20,"/":20,"%":20};return k()}var u={type:"bool",value:!1};n.Mason=n.Mason||{},n.Mason.AST=function(n){return e(t(r(n)))}}(window);